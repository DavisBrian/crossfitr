---
title: "\'Twas the night before the Open"
author: "Brian Davis"
date: "`r format(Sys.time(), '%d %B, %Y')`"
published: false
status: process
draft: false
output: html_document
---

```{r setup, echo=FALSE, message=FALSE, warning=FALSE}
library(tidyverse)
library(lubridate)
library(ggplot2)
library(scales)
library(knitr)
library(printr)
library(xtable)

## Load and Clean Data ---------------------------------------------------------

# read the data in (generated by propel_affiliate_scrape.R)
# athletes <- readRDS(file = "./data/Propel/propel_athlete_profiles_2017.rds")
athletes <- readRDS(file = "~/Projects/crossfitr/data/Propel/propel_athlete_profiles_2017.rds")

# functions for later
height_as_text <- function(ht) {
  paste0(floor(ht/12L), "' ", ht%%12L, "\"")
}

fix_benchmark <- function(x) {
  x <- gsub("_", ' ', x)
  s <- strsplit(x, " ")[[1]]
  paste(toupper(substring(s, 1,1)), substring(s, 2),
        sep="", collapse=" ")
}
```

How does a data scientist prepare for the [Crossfit
Open](https://games.crossfit.com/)?  You scrape the games site and analyze it of
course.

Since [our gym](http://crossfitpropel.com/) is having our own head-head
throw-down for each Open workout I figured I'd take a look at our Open
participation stats.  Here is a quick look at how the `r nrow(athletes)`
athletes we have registered for the Crossfit Open breakdown. 


### Age

```{r age, echo=FALSE}
athletes <- athletes %>% 
  mutate(age_group =  factor(x = gsub(" (Men|Women|Boys|Girls)", '', division),
                             levels = c("Teenage (14-15)", "Teenage (16-17)",
                                        "Individual", "Masters (35-39)",
                                        "Masters (40-44)", "Masters (45-49)",
                                        "Masters (50-54)", "Masters (55-59)",
                                        "Masters (60+)"),
                             labels = c("14-15", "16-17", "18-34", "35-39",
                                        "40-44", "45-49", "50-54", "55-59",
                                        "60+")))

ggplot(athletes, mapping = aes(x=age_group, fill = gender)) +
  geom_bar(aes(y=..count../sum(..count..)), position="dodge") +
  scale_y_continuous(labels=percent) +
  labs(fill="Gender",x='Age Group',y="% of Athletes") +
  theme_bw(base_size=18) +
  theme(legend.position = c(.88, .88))
```

As gym we have every division **except** Teenage (16-17) represented.  We have
strong millennial representation, but we also have a large 40+ crowd too. 
Now "Get off my lawn!"

### Height

The first thing I noticed when I looked at the height of our participants is a couple people seemed to have filled out their profile a bit wrong.

```{r height, echo=FALSE}
# Fix a couple people who entered their height as inches
ht_tbl <- athletes %>% 
  filter(height < 12) %>% 
  select(athlete_name, division, height) %>%
  mutate(height = height_as_text(height))

knitr::kable(ht_tbl, col.names=c("Name", "Division", "Height"), align = c('r', 'c', 'c'))
```

I assume they meant feet not inches when they were filling out their stats so I corrected them, although I'm pretty sure Jason is taller than 5 feet.

```{r height_plot, echo=FALSE, warning=FALSE}
athletes <- athletes %>% 
  mutate(height = if_else(height < 12, 12*height, height))

variable <- "height"
binwidth <- 1
limits   <- c(57, 76)
breaks   <- seq(57, 81, by = 3)
labels   <- c("4\'9\"","5\'","5\'3\"","5\'6\"","5\'9\"","6\'","6\'3\"","6\'6\"","6\'9\"")
xlab     <- "Height (feet/in)"

ggplot(athletes, mapping = aes(x=height, fill = gender)) +
  geom_histogram(aes(y=..density..),binwidth=binwidth, position="dodge") +
  geom_density(alpha=.4,adjust=3, color=NA) +
  scale_y_continuous(labels=percent) +
  scale_x_continuous(limits = limits,
                     breaks = breaks,
                     labels = labels) +
  labs(fill="Gender",x=xlab,y="% of Athletes") +
  theme_bw(base_size=18) +
  theme(legend.position = c(.88, .88))
```

How many of you guys are actually 5’11” but thought it wouldn’t hurt anybody if you rounded up to 6’0″?  The large dip between 5'10" and 6'0" seems to indicate we have a couple guys with wishful thinking.

### Other Metrics

Originally I was going to do the above plots for each benchmark WOD.  Unfortunately, we either haven't done them recently or we didn't feel the desire to fill in our scores.

```{r other_metrics, echo=FALSE, warning=FALSE}
bstats <- athletes %>%
  gather("metric", "value", 10:21) %>%
  group_by(metric) %>%
  summarise(cnt = sum(!is.na(value)),
            miss = sum(is.na(value))) %>%
  mutate(metric = sapply(metric, fix_benchmark)) %>%
  arrange(desc(cnt))

knitr::kable(bstats, 
             col.names=c("Benchmark Stat", "Count", "Missing"), align = c('l', 'c', 'c'))
```

### Final Thoughts

Well you made it to the end!  Hopefully I'll get the team members for each of our internal teams and I can break down the scores of each workout by team.  Otherwise I'll just summarize for the gym overall.